# ### 1. Import basemap data:
# - This includes Coastlines, bathymetry, NBW habitat area, and conservation zones 
# - Code imports data and transforms to UTM Zone 20 where necessary
# - Extent of study area is based on area of influence around NBW habitat being a 50km buffer of the 1000m bathy line
# - Bathymetric data from Atlas of Canada available at: (https://ftp.maps.canada.ca/pub/nrcan_rncan/vector/framework_cadre/North_America_Atlas10M/bathymetry/)
# - Conservation zones compiled from layers available as shapefiles. 
# - OECMS from https://open.canada.ca/data/en/dataset/44769543-7a23-4991-a53f-c2cf7c7a946f  
# - Ocean's Act MPAs from https://open.canada.ca/data/en/dataset/a1e18963-25dd-4219-a33f-1a38c4971250  
#     - Georges Bank Oil and Gas Exclusion zone from CNSOPB https://callforbids.cnsopb.ns.ca/2016/01/data-environment/gis-information  
#     - Northern bottlenose whale Critical Habitat designations from Species at Risk https://open.canada.ca/data/en/dataset/db177a8c-5d7d-49eb-8290-31e6a45d786c  
# 
#libraries----------
#might not need all these...
library(readr)
library(rgdal) # to read shapefiles
library(raster) # for the various raster functions
library(sp) # Classes and methods for spatial data
library(dplyr)
library(sf)
library(viridis)
library(ggplot2)
library(rgeos)
library("ggrepel")
library(stars)
library(stringr)
library(here)
library(fasterize)
library(ggtext)
library(ggspatial)
library("rnaturalearth")
library("rnaturalearthdata")
library(rnaturalearthhires)
library(pals) 
library(tidyr)
library(fuzzyjoin)
library(patchwork)
library(ggtext)
library(ggforce)


#projection------

#UTM
UTM20 <- CRS("+init=epsg:32620") # CODE FOR UTM Zone 20

file.shapes = "~/DRIVE/CODE/SDM/TowedArray/Shapes/"

# boundbox for study area-----
bound <- st_bbox( c(xmin = -70,ymin = 38, xmax = -45, ymax =60 ), crs = st_crs(4326))
# bound <- detect_NAFO + c(-8, -3,60,12) # Increase the area around the box a bit (in degrees)
bound <- bound %>%st_as_sfc()%>% #turns the bounding box into a sfc object, that just describes a specific geometry
  st_sf()%>%st_transform(4326)
boundUTM <- bound %>%
  st_transform(UTM20)


# bathy data -------
# from Atlas of Canada Data (https://ftp.maps.canada.ca/pub/nrcan_rncan/vector/framework_cadre/North_America_Atlas10M/bathymetry/)

bathy <- read_sf(paste(file.shapes, "bathymetry_pl_v2/bathymetry_l_v2.shp", sep = ""))

#change projection from Albers to Lat Long
#filter to show depths of interest

bathy = bathy%>% 
  st_transform(4326)%>%
  filter(DEPTH >150)

#transform to UTM for later
bathyUTM = bathy%>% 
  st_transform(UTM20)

# north america for reference------
land <- ne_countries( scale = "large",continent = "north america", returnclass = "sf")
landUTM = land%>%st_transform(UTM20) 

# import NBW Sightings
sightHa = read_csv(here::here("data/cetacean_sightings_trip1.csv"))%>%filter(Species == "Northern Bottlenose")
sightHa = st_as_sf(sightHa, coords = c("Longitude", "Latitude"), crs = 4326)%>%st_transform(UTM20)

# import ship track 
ship = read_rds(here::here("data/shipTrack.rds"))%>%

sightHa = st_as_sf(sightHa, coords = c("Longitude", "Latitude"), crs = 4326)%>%st_transform(UTM20)


#  plot basemap as object m-----
m<-ggplot() +
  scale_fill_viridis(discrete = T, option = "D")+
  theme_bw()+
  # add land region
  geom_sf(  data = land, color=NA, fill="grey50") +
  
  # add contours
  geom_sf(data = bathy, col = "gray", size = 0.2) +
  
  #add sightings of NBW
  
  geom_sf(data = sightHa, aes(colour = Species), fill = NA, 
          size = 1.2, shape = 18) +
  
  # set map limits
  coord_sf(xlim = c(-65, -51), ylim = c(65, 69)) +
  ##ff593d,#93003a
 
  guides(fill = guide_legend(ncol = 5))+
  # format axes
  ylab("") + 
  xlab("") +
  theme(plot.margin = margin(.1, .5, .1, .1, "cm"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position="bottom", legend.title = element_blank()    )
m

 
#save map
 
 gg_Fig2path =  here::here("FIGS/Sightings.png")
ggsave(gg_Fig2path, m, width = 7, height = 5, units = "in", dpi = 300)


